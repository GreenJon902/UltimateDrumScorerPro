#:import Clock kivy.clock.Clock
#:import GlobalBindings app.globalBindings.GlobalBindings

#:set bar_size 50
#:set bar_size_hint None

#:set header_color ([0.5] * 3)
#:set side_bar_color ([0.4] * 3)
#:set bg_color ([0.2] * 3)

#:set score_zoom_start 0.5
#:set score_zoom_min 0.1
#:set score_zoom_max 2
#:set score_zoom_step 0.01

#:set score_zoom_bar_width 300
#:set score_zoom_bar_size_hint_x None
#:set score_zoom_sign_color ([0.2] * 3)

#:set staff_height 500
#:set staff_gap staff_height / 4
#:set staff_color ([0] * 3)
#:set staff_line_width 5
#:set bar_edge_line_width 30

#:set one_line_text_box_height 30

#:set add_text_popup_font_size_min_mm 5
#:set add_text_popup_font_size_max_mm 50
#:set add_text_popup_font_size_default_mm 10

#:set mode_button_path "atlas://resources/atlases/buttons/{name}_button_{state}"


BoxLayout:
    orientation: "vertical"

    BoxLayout: # HeaderBar
        size_hint_y: bar_size_hint
        height: bar_size


        canvas.before:
            Color:
                rgb: header_color

            Rectangle:
                pos: self.pos
                size: self.size

        Widget: # Spacer


        Image:
            source: "resources/zoom_minus_sign.png"
            size_hint_x: None
            on_height: self.width = self.height
            color: score_zoom_sign_color

        Slider:
            size_hint_x: score_zoom_bar_size_hint_x
            width: score_zoom_bar_width

            min: score_zoom_min
            max: score_zoom_max
            step: score_zoom_step

            value: score_zoom_start
            on_value: score_view.zoom = args[1]

        Image:
            source: "resources/zoom_plus_sign.png"
            size_hint_x: None
            on_height: self.width = self.height
            color: score_zoom_sign_color



    BoxLayout:
        orientation: "horizontal"




        BoxLayout: # SideBar
            orientation: "vertical"

            size_hint_x: bar_size_hint
            width: bar_size

            canvas.before:
                Color:
                    rgb: side_bar_color

                Rectangle:
                    pos: self.pos
                    size: self.size

            NoDisableSquareToolTipHoverButtonW:
                name: "move"
                on_press: GlobalBindings.dispatch("sidebar_button_clicked", self)

                tooltip_text: "Move the screen! Hotkey - \"m\""

            NoDisableSquareToolTipHoverButtonW:
                name: "text"
                on_press: GlobalBindings.dispatch("sidebar_button_clicked", self)

                tooltip_text: "Add Text! Hotkey - \"m\""

            NoDisableSquareToolTipHoverButtonW:
                name: "section"
                on_press: GlobalBindings.dispatch("sidebar_button_clicked", self)

            NoDisableSquareToolTipHoverButtonW:
                name: "note"
                on_press: GlobalBindings.dispatch("sidebar_button_clicked", self)


            Widget:




        BoxLayout: # BG
            canvas.before:
                Color:
                    rgb: bg_color

                Rectangle:
                    pos: self.pos
                    size: self.size


            ScoreView:
                id: score_view

                zoom: score_zoom_start





    FloatLayout:
        size_hint: None, None
        size: 0, 0

        CustomMouse:
            id: custom_mouse




<_ToolTipHoverButton@BoxLayoutWithToolTipClickHoverEvent>:
    name: "unknown"

    on_press: image.source = mode_button_path.format(name=root.name, state="click")
    on_name: image.source = (mode_button_path.format(name=root.name, state="click") if self.state == "down" else (mode_button_path.format(name=root.name, state="hover") if self.mouse_over else (mode_button_path.format(name=root.name, state="normal"))))

    Image:
        id: image


<NoDisableToolTipHoverButton@_ToolTipHoverButton>:
    on_mouse_enter: root.ids.image.source = mode_button_path.format(name=root.name, state="hover") if root.ids.image.source == mode_button_path.format(name=root.name, state="normal") else root.ids.image.source
    on_mouse_leave: root.ids.image.source = mode_button_path.format(name=root.name, state="normal") if root.ids.image.source == mode_button_path.format(name=root.name, state="hover") else root.ids.image.source


<ToolTipHoverButton@_ToolTipHoverButton>:
    on_mouse_enter: root.ids.image.source = mode_button_path.format(name=root.name, state="hover")
    on_mouse_leave: root.ids.image.source = mode_button_path.format(name=root.name, state="normal")
    on_release: root.ids.image.source = mode_button_path.format(name=root.name, state="hover")




<NoDisableSquareToolTipHoverButtonW@NoDisableToolTipHoverButton>:
    size_hint_y: None
    on_width: self.height = self.width

<NoDisableSquareToolTipHoverButtonH@NoDisableToolTipHoverButton>:
    size_hint_x: None
    on_width: self.width = self.height



<SquareToolTipHoverButtonW@ToolTipHoverButton>:
    size_hint_y: None
    on_width: self.height = self.width

<SquareToolTipHoverButtonH@ToolTipHoverButton>:
    size_hint_x: None
    on_width: self.width = self.height




# Score Content

<Page>:
    canvas.before:
        PushMatrix
        Scale:
            xyz: self.scale_xyz

    canvas.after:
        PopMatrix


<PageBg>:
    canvas:
        Color:
            rgb: 255, 255, 255
        Rectangle:
            pos: 0, 0
            size: self.size


<Text>:
    Image:
        id: image



<Bar>:
    height: staff_height
    size_hint_x: None

    canvas:
        Color:
            rgb: staff_color

        Line:
            points: 0, staff_gap * 0, self.width, staff_gap * 0
            width: staff_line_width

        Line:
            points: 0, staff_gap * 1, self.width, staff_gap * 1
            width: staff_line_width

        Line:
            points: 0, staff_gap * 2, self.width, staff_gap * 2
            width: staff_line_width

        Line:
            points: 0, staff_gap * 3, self.width, staff_gap * 3
            width: staff_line_width

        Line:
            points: 0, staff_gap * 4, self.width, staff_gap * 4
            width: staff_line_width


        Line:
            points: 0, 0, 0, staff_height
            width: staff_line_width
            cap: "none"

        Line:
            points: self.width, 0, self.width, staff_height
            width: bar_edge_line_width
            cap: "none"




# Popups

<AddTextPopup>:
    title: "Text"
    size_hint: 0.5, 0.5

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"

            Label:
                text: "Text "
                size_hint_x: None
                on_texture_size: self.width = self.texture.size[0]

            TextInput:
                id: text
                hint_text: "Enter your text"



        BoxLayout:
            orientation: "horizontal"

            size_hint_y: None
            height: font_size.height

            Label:
                text: "Font Size (mm) "
                size_hint: None, None
                on_texture_size: self.width = self.texture.size[0]
                height: font_size.height

            SliderWithText:
                id: font_size

                min: add_text_popup_font_size_min_mm
                max: add_text_popup_font_size_max_mm
                value: add_text_popup_font_size_default_mm

                hint_text: "Font Size"



        Button:
            text: "Finish"
            on_release: root.on_finish_button(self, "down")




<AddSectionPopup>:
    title: "Section"
    size_hint: 0.5, 0.5

    BoxLayout:
        orientation: "vertical"


        BoxLayout:
            orientation: "horizontal"

            Label:
                text: "Section Name "
                size_hint_x: None
                on_texture_size: self.width = self.texture.size[0]

            TextInput:
                id: name
                hint_text: "Enter this section's name"



        Button:
            text: "Finish"
            on_release: root.on_finish_button(self, "down")


# Misc

<SliderWithText>:
    size_hint_y: None
    height: one_line_text_box_height

    TextInput:
        id: text_input
        multiline: False
        hint_text: root.hint_text

        on_text_validate: root.validate_text()
        on_focus: root.validate_text()

    Slider:
        id: slider
        orientation: root.orientation

        min: root.min
        max: root.max

        on_value: root.value = self.value
